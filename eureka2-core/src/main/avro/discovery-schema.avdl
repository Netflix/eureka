@namespace("com.netflix.eureka2.protocol.discovery")
protocol DiscoveryProtocol {

    import idl "eureka-registry-model.avdl";
    import idl "eureka-interest-model.avdl";

    @namespace("com.netflix.eureka2.transport")
    record Acknowledgement {
    }

    @namespace("com.netflix.eureka2.protocol")
    record Heartbeat {
    }

    record AddInstance {
        com.netflix.eureka2.registry.instance.InstanceInfo instanceInfo;
    }

    record DeleteInstance {
        string instanceId;
    }

    @namespace("com.netflix.eureka2.interests.StreamState$")
    enum Kind {
        Snapshot, Live
    }

    @namespace("com.netflix.eureka2.interests")
    record StreamState {
        com.netflix.eureka2.interests.StreamState$.Kind kind;
        union {
            com.netflix.eureka2.interests.ApplicationInterest,
            com.netflix.eureka2.interests.FullRegistryInterest,
            com.netflix.eureka2.interests.VipInterest,
            com.netflix.eureka2.interests.InstanceInterest
        } interest;
    }

    record StreamStateUpdate {
        com.netflix.eureka2.interests.StreamState state;
    }

    @namespace("com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$")
    record StringDeltaDTO {
        string id;
        string fieldName;
        union { null, string } value;
    }
    @namespace("com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$")
    record EnumDeltaDTO {
        string id;
        string fieldName;
        union { null, com.netflix.eureka2.registry.instance.InstanceInfo$.Status } value;
    }
    @namespace("com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$")
    record SetServicePortDeltaDTO {
        string id;
        string fieldName;
        union { null, @java-class("java.util.HashSet") array<com.netflix.eureka2.registry.instance.ServicePort> } value;
    }
    @namespace("com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$")
    record SetStringDeltaDTO {
        string id;
        string fieldName;
        union { null, @java-class("java.util.HashSet") array<string> } value;
    }

    @namespace("com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$")
    record MapStringDeltaDTO {
        string id;
        string fieldName;
        union { null, @java-class("java.util.HashMap") map<string> } value;
    }

    @namespace("com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$")
    record DataCenterInfoDTO {
        string id;
        string fieldName;
        union {
            null,
            com.netflix.eureka2.registry.datacenter.BasicDataCenterInfo,
            com.netflix.eureka2.registry.datacenter.AwsDataCenterInfo
         } value;
    }

    record UpdateInstanceInfo {
        union {
            com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$.StringDeltaDTO,
            com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$.EnumDeltaDTO,
            com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$.SetServicePortDeltaDTO,
            com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$.SetStringDeltaDTO,
            com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$.MapStringDeltaDTO,
            com.netflix.eureka2.protocol.discovery.UpdateInstanceInfo$.DataCenterInfoDTO
        } deltaDTO;
    }

    record InterestRegistration {
        @java-class("[Lcom.netflix.eureka2.interests.Interest;")
        array<
            union {
                com.netflix.eureka2.interests.ApplicationInterest,
                com.netflix.eureka2.interests.FullRegistryInterest,
                com.netflix.eureka2.interests.EmptyRegistryInterest,
                com.netflix.eureka2.interests.VipInterest,
                com.netflix.eureka2.interests.InstanceInterest
            }
        > interests;
    }

    record UnregisterInterestSet {
    }

    record SnapshotRegistration {
        @java-class("[Lcom.netflix.eureka2.interests.Interest;")
        array<
            union {
                com.netflix.eureka2.interests.ApplicationInterest,
                com.netflix.eureka2.interests.FullRegistryInterest,
                com.netflix.eureka2.interests.EmptyRegistryInterest,
                com.netflix.eureka2.interests.VipInterest,
                com.netflix.eureka2.interests.InstanceInterest
            }
        > interests;
    }

    record SnapshotComplete {
    }

    record DiscoveryMessage {
        union {
            AddInstance,
            DeleteInstance,
            StreamStateUpdate,
            UpdateInstanceInfo,
            InterestRegistration,
            UnregisterInterestSet,
            com.netflix.eureka2.transport.Acknowledgement,
            com.netflix.eureka2.protocol.Heartbeat,
            SnapshotRegistration,
            SnapshotComplete
        } message;
    }
}